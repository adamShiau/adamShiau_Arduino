å¤ªå¯ä»¥ï¼æˆ‘å¹«ä½ ç”¨ã€Œç”¨é€”å¼ã€çš„æ–¹å¼ç•«å¹¾å¼µ Mermaid æµç¨‹åœ–ï¼Œæ”¾é€² Obsidian å°±èƒ½ç›´æ¥çœ‹ã€‚é‡é»æŠŠ **Typeï¼ˆdata_typesï¼‰â†’ Adapter â†’ Mathï¼ˆmath_utilsï¼‰** çš„è³‡æ–™æµè¬›æ¸…æ¥šï¼Œä¸¦ç¤ºç¯„å…©å€‹æœ€å¸¸ç”¨çš„å ´æ™¯ã€‚

---

# ç¸½è¦½ï¼šè³‡æ–™å¦‚ä½•åœ¨ Type / Adapter / Math ä¹‹é–“æµå‹•

```mermaid
flowchart TD
  %% åˆ†é¡æ¨£å¼
  classDef io fill:#FFF1F0,stroke:#F5222D,rx:8,ry:8
  classDef type fill:#E6F7FF,stroke:#1890FF,rx:8,ry:8
  classDef adapter fill:#FFF7E6,stroke:#FA8C16,rx:8,ry:8
  classDef math fill:#F6FFED,stroke:#52C41A,rx:8,ry:8
  classDef module fill:#F9F0FF,stroke:#722ED1,rx:8,ry:8

  subgraph IO[IO / ç¡¬é«” & è¼¸å‡º]
    HAL[HAL/Drivers]:::io
    PROTO[Protocol Output<br/>MAVLink / AR1AFC / MTI]:::io
  end

  subgraph DATA[Typeï¼ˆç´”è³‡æ–™çµæ§‹ï¼‰]
    IMU[IMUData]:::type
    GNSS[GNSSData]:::type
    NAV[NavigationState]:::type
  end

  subgraph ADP[Adapterï¼ˆæ“·å–/è½‰æ›/å›å¯«ï¼‰]
    IADP[IMUAdapter<br/>æ„Ÿæ¸¬å™¨æ•¸æ“šæ“·å–]:::adapter
    GADP[GNSSAdapter<br/>èˆªå‘/ä½ç½®è™•ç†]:::adapter
    CADP[CoordAdapter<br/>åº§æ¨™ç³»è½‰æ›æ ¸å¿ƒ]:::adapter
    NADP[NavigationAdapter<br/>ç‹€æ…‹ç®¡ç†/èåˆ]:::adapter
  end

  subgraph MATH[Mathï¼ˆç´”æ•¸å­¸å‡½å¼åº«ï¼‰]
    MU[MathUtils.h/.cpp]:::math
  end

  HAL -->|å¡«å€¼| IMU
  HAL -->|å¡«å€¼| GNSS

  IMU -->|const& æ“·å–| IADP
  GNSS -->|const& æ“·å–| GADP
  IADP -->|å‘¼å«| MU
  GADP -->|å‘¼å«| MU
  CADP -->|å‘¼å«| MU
  NADP -->|å‘¼å«| MU

  NADP -->|å›å¯«/æ›´æ–°| NAV
  NAV --> PROTO

  %% å…¶ä»–é€£çµ - åº§æ¨™è½‰æ›æ”¯æ´
  IADP -.->|åº§æ¨™ç³»è½‰æ›éœ€æ±‚| CADP
  GADP -.->|èˆªå‘æ ¡æ­£è¨ˆç®—| CADP
  CADP -.->|å››å…ƒæ•¸/æ­æ‹‰è§’è½‰æ›| NADP
```

- **Type**ï¼šåªå­˜è³‡æ–™ï¼ˆä¸åšè¨ˆç®—ã€ä¸é…è¨˜æ†¶é«”ï¼‰ã€‚
    
- **Adapter**ï¼šå¾ Type æŠ½æ¬„ä½ â†’ å‘¼å« Math â†’ å›å‚³æˆ–å›å¯«ï¼ˆä¸åšå‹•æ…‹é…ç½®ï¼‰ã€‚
    
- **Math**ï¼šç´”å‡½å¼ã€åƒ/åæ¨™æº–å‹åˆ¥ï¼ˆfloatã€é™£åˆ—ã€Vector3fâ€¦ï¼‰ã€‚
    

---

# ç”¨é€” 1ï¼šå¾ IMU å››å…ƒæ•¸å–å¾—æ­æ‹‰è§’ï¼ˆä¸æ”¹å‹• Typeï¼‰

```mermaid
flowchart LR
  IMU[IMUData]
  IADP[IMUAdapter::extractEulerAngles]
  MU[MathUtils::quaternion_to_euler_ned]
  CALLER[å‘¼å«ç«¯ä½¿ç”¨çµæœ]

  IMU -->|è®€å– quat_w/x/y/z èˆ‡æ——æ¨™ IMU_QUATERNION_VALID| IADP
  IADP -->|å‘¼å«| MU
  MU --> IADP
  IADP -->|å›å‚³ roll pitch yaw rad| CALLER


```
**é—œéµé»**

- Adapter ä»¥ `const IMUData&` æ“·å–æ¬„ä½ï¼Œ**ä¸æ”¹ IMUData**ã€‚
    
- å›å‚³ä¸‰å€‹è§’ï¼ˆå¼§åº¦ï¼‰ï¼›æ˜¯å¦è½‰æˆåº¦æ•¸äº¤ç”±å‘¼å«ç«¯ï¼ˆé¿å…éš±æ€§å–®ä½è½‰æ›ï¼‰ã€‚
    

---

# ç”¨é€” 2ï¼šGNSS èˆªå‘ vs IMU Yaw â†’ è¨ˆç®— Shiftï¼Œä¸¦æ‡‰ç”¨åˆ° NavigationState

```mermaid
flowchart TD
  classDef type fill:#E6F7FF,stroke:#1890FF,rx:8,ry:8
  classDef adapter fill:#FFF7E6,stroke:#FA8C16,rx:8,ry:8
  classDef math fill:#F6FFED,stroke:#52C41A,rx:8,ry:8

  IMU[IMUData]:::type -->|extractEulerAngles å– yaw| IADP[IMUAdapter::extractEulerAngles]:::adapter
  IADP --> MU1[MathUtils::quaternion_to_euler_ned]:::math --> IADP
  IADP -->|imu_yaw| GADP[GNSSAdapter::calculateShiftOffset]:::adapter
  GNSS[GNSSData]:::type -->|getHeading + æª¢æŸ¥ç²¾åº¦/æ——æ¨™| GADP
  GADP --> MU2[MathUtils::calculate_shift_offset]:::math --> GADP
  GADP -->|shift_offset| NADP[NavigationAdapter::applyYawShiftToQuaternion]:::adapter
  NADP --> CADP[CoordAdapter::multiplyQuaternions]:::adapter
  CADP --> MU3[MathUtils::quaternion_multiply]:::math --> CADP
  CADP --> NADP
  NADP -->|æ›´æ–° quat / è¨­ NAV_SHIFT_CORRECTED / å¯« applied_shift_offset| NAV[NavigationState]:::type
```

**é—œéµé»**

- `GNSSAdapter::calculateShiftOffset()`ï¼šè¼¸å…¥ `GNSSData`ï¼ˆå«æ——æ¨™èˆ‡ç²¾åº¦é–€æª»ï¼‰+ `imu_yaw` â†’ å›å‚³ `shift_offset`ã€‚
    
- `NavigationAdapter::applyYawShiftToQuaternion()`ï¼šä½¿ç”¨ CoordAdapter é€²è¡Œå››å…ƒæ•¸ä¹˜æ³•ï¼Œå°±åœ°æ›´æ–° `NavigationState` çš„å››å…ƒæ•¸èˆ‡æ——æ¨™ã€‚

- `CoordAdapter::multiplyQuaternions()`ï¼šå°è£ MathUtils çš„å››å…ƒæ•¸ä¹˜æ³•ï¼Œç”¨æ–¼ Shift æ ¡æ­£æ‡‰ç”¨ã€‚
    

---

# ç”¨é€” 3ï¼ˆåŠ ç¢¼ï¼‰ï¼šFusion ä½¿ç”¨å‘é‡/çŸ©é™£ï¼ˆåªè®€ Typeã€é‡ç”¨ Mathï¼‰

```mermaid
flowchart LR
  classDef type fill:#E6F7FF,stroke:#1890FF,rx:8,ry:8
  classDef adapter fill:#FFF7E6,stroke:#FA8C16,rx:8,ry:8
  classDef math fill:#F6FFED,stroke:#52C41A,rx:8,ry:8
  classDef module fill:#F9F0FF,stroke:#722ED1,rx:8,ry:8

  IMU[IMUData]:::type --> IADP[IMUAdapter::getAccelerationVector/<br/>getGyroVector]:::adapter
  GNSS[GNSSData]:::type --> GADP[GNSSAdapter::getVelocityVector/<br/>getPosition]:::adapter
  IADP --> FUSION[EKF / FusionEngine]:::module
  GADP --> FUSION
  FUSION -->|éœ€è¦æ—‹è½‰/çŸ©é™£/çµ±è¨ˆ| MU[MathUtils.h/.cpp]:::math
  FUSION -->|ä½¿ç”¨åº§æ¨™è½‰æ›| CADP[CoordAdapter::eulerToQuaternion/<br/>bodyToNed]:::adapter
  CADP --> MU
  FUSION -->|è¼¸å‡ºå§¿æ…‹/ä½ç½®/é€Ÿåº¦| NADP[NavigationAdapter::updateFromFusionOutput]:::adapter --> NAV[NavigationState]:::type
```

**é—œéµé»**

- Fusion æ¨¡çµ„**åªç”¨** Adapter æä¾›çš„å‘é‡/çŸ©é™£å…¥å£ï¼Œä¸ç›´æ¥ç¢° `IMUData` æ¬„ä½ã€‚
    
- æ‰€æœ‰æ•¸å­¸ï¼ˆçŸ©é™£é€†ã€æ¿¾æ³¢ã€çµ±è¨ˆï¼‰çµ±ä¸€èµ° `MathUtils`ã€‚
    

---

## ä¸€å¥è©±ç¸½çµ

> **Type ç®¡è³‡æ–™ã€Adapter åšæ“·å–èˆ‡å›å¯«ã€Math åšè¨ˆç®—ã€‚**  
> Adapter æ°¸é ã€Œè®€ Type â†’ å‘¼å« Math â†’ å›å‚³/å¯«å› Typeã€ï¼Œä¸åšå‹•æ…‹è¨˜æ†¶é«”é…ç½®ã€‚

---

## ğŸ“‹ å¯¦éš›å‡½æ•¸åç¨±å°ç…§è¡¨

### IMUAdapter å¯¦éš›å‡½æ•¸
- `extractEulerAngles()` - å¾å››å…ƒæ•¸æå–æ­æ‹‰è§’
- `extractQuaternion()` - æå–ä¸¦é©—è­‰å››å…ƒæ•¸
- `getAccelerationVector()` - æå–åŠ é€Ÿåº¦å‘é‡ (Body frame)
- `getGyroVector()` - æå–è§’é€Ÿåº¦å‘é‡ (Body frame)
- `getMagnetometerVector()` - æå–ç£åŠ›è¨ˆå‘é‡ (Body frame)
- `getYawAngle()` - æå–åèˆªè§’ï¼ˆå¼§åº¦ï¼‰
- `isDataValid()` - ç¶œåˆæ•¸æ“šæœ‰æ•ˆæ€§æª¢æŸ¥

### GNSSAdapter å¯¦éš›å‡½æ•¸
- `getHeading()` - æå–èˆªå‘è§’ï¼ˆå¼§åº¦ï¼‰
- `getHeadingDegrees()` - æå–èˆªå‘è§’ï¼ˆåº¦æ•¸ï¼‰
- `calculateShiftOffset()` - è¨ˆç®—èˆ‡ IMU çš„ Shift åç§»
- `getPosition()` - æå– WGS84 ä½ç½®æ•¸æ“š
- `getVelocityVector()` - æå–é€Ÿåº¦å‘é‡ (NED)
- `calculateDataQuality()` - è¨ˆç®—æ•¸æ“šå“è³ªåˆ†æ•¸ (0-100)
- `isValidForShiftCalibration()` - æª¢æŸ¥æ˜¯å¦é©åˆ Shift æ ¡æ­£

### CoordAdapter å¯¦éš›å‡½æ•¸
- `eulerToQuaternion()` - æ­æ‹‰è§’ â†’ å››å…ƒæ•¸ (NEDç³»)
- `quaternionToEuler()` - å››å…ƒæ•¸ â†’ æ­æ‹‰è§’ (NEDç³»)
- `multiplyQuaternions()` - å››å…ƒæ•¸ä¹˜æ³•
- `nedToEnu()` / `enuToNed()` - NED â†” ENU åº§æ¨™è½‰æ›
- `bodyToNed()` / `nedToBody()` - Body â†” NED åº§æ¨™è½‰æ›
- `calculateShiftOffset()` - è¨ˆç®— GNSS-IMU Shift åç§»é‡
- `applyShiftCorrection()` - æ‡‰ç”¨ Shift æ ¡æ­£

### NavigationAdapter å¯¦éš›å‡½æ•¸
- `extractQuaternion()` - æå–å°èˆªç‹€æ…‹å››å…ƒæ•¸
- `extractEulerAngles()` - æå–å°èˆªç‹€æ…‹æ­æ‹‰è§’
- `updateQuaternion()` - æ›´æ–°å››å…ƒæ•¸ç‹€æ…‹
- `applyYawShiftToQuaternion()` - å››å…ƒæ•¸æ¨¡å¼ Shift æ ¡æ­£
- `applyYawShiftToEuler()` - æ­æ‹‰è§’æ¨¡å¼ Shift æ ¡æ­£
- `updateFromFusionOutput()` - å¾èåˆè¼¸å‡ºæ›´æ–°ç‹€æ…‹
- `updatePosition()` / `updateVelocity()` - æ›´æ–°ä½ç½®/é€Ÿåº¦ç‹€æ…‹

---

## ğŸ—ï¸ æ¶æ§‹æª¢æŸ¥çµæœ

âœ… **å®Œå…¨ç¬¦åˆé æœŸçš„è¨­è¨ˆ:**
- **åˆ†å±¤æ¸…æ¥š**: Type â†’ Adapter â†’ Math ä¸‰å±¤æ¶æ§‹å®Œæ•´
- **è·è²¬æ˜ç¢º**: æ¯å€‹ Adapter éƒ½æœ‰ç‰¹å®šç”¨é€”å’Œæ¸…æ™°é‚Šç•Œ
- **ç„¡ç‹€æ…‹è¨­è¨ˆ**: æ‰€æœ‰ Adapter éƒ½æ˜¯ç´”å‡½æ•¸ï¼Œç„¡å…§éƒ¨ç‹€æ…‹
- **çµ±ä¸€ä»‹é¢**: éŒ¯èª¤è™•ç†ã€åƒæ•¸å‚³éã€å‘½åç´„å®šéƒ½ä¸€è‡´
- **ä¾è³´æ­£ç¢º**: Adapter åªä¾è³´ data_types.h å’Œ math_utils.h

âœ… **CoordAdapter æ ¸å¿ƒåœ°ä½ç¢ºç«‹**:
- æä¾›æ‰€æœ‰åº§æ¨™ç³»è½‰æ›çš„çµ±ä¸€å…¥å£
- å°è£è¤‡é›œçš„æ•¸å­¸é‹ç®—ç‚ºèªç¾©åŒ–ä»‹é¢
- æ”¯æ´å…¶ä»– Adapter çš„åº§æ¨™è½‰æ›éœ€æ±‚

âœ… **å¯¦éš›ä½¿ç”¨æµç¨‹å®Œæ•´**:
- IMU æ•¸æ“šæ“·å– â†’ æ•¸å­¸è¨ˆç®— â†’ ç‹€æ…‹æ›´æ–°
- GNSS æ ¡æ­£ â†’ Shift è¨ˆç®— â†’ å››å…ƒæ•¸ä¿®æ­£
- èåˆå¼•æ“ â†’ å¤šæºæ•¸æ“šè™•ç† â†’ çµ±ä¸€è¼¸å‡º

é€™å€‹æ¶æ§‹è¨­è¨ˆå®Œå…¨ç¬¦åˆé æœŸï¼Œç‚º GMINS ç³»çµ±æä¾›äº†ç©©å›ºçš„åŸºç¤ï¼