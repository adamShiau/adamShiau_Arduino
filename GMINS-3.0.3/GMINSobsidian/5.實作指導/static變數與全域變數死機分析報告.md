# staticè®Šæ•¸èˆ‡å…¨åŸŸè®Šæ•¸æ­»æ©Ÿåˆ†æå ±å‘Š

> **æ–‡ä»¶ç‰ˆæœ¬**: 1.0  
> **å»ºç«‹æ—¥æœŸ**: 2025-08-22  
> **å°ˆæ¡ˆ**: GMINS ç³»çµ±ç©©å®šæ€§åˆ†æ  
> **åˆ†æç¯„åœ**: aa4ca7c â†’ b3a0829 ä¹‹é–“çš„æ­»æ©ŸåŸå› 

## ğŸš¨ åŸ·è¡Œæ‘˜è¦

é€éå°æ¯” aa4ca7c (ç©©å®š) èˆ‡ b3a0829 (æ­»æ©Ÿ) ç‰ˆæœ¬ï¼Œç™¼ç¾ commit 53442ca ä¸­çš„ IMU adapter ä¿®æ”¹æ˜¯ä¸»è¦æ­»æ©Ÿæ ¹å› ã€‚å•é¡Œæ ¸å¿ƒæ˜¯ï¼š**å‡½å¼å…§staticçš„å®ˆé–€æª¢æŸ¥ + é«˜é »LOGèª¿ç”¨ + è‡ªè£½millis()ç†±è·¯å¾‘èª¿ç”¨**ï¼Œè€Œéè¨˜æ†¶é«”æ´©æ¼æˆ–ç¢ç‰‡åŒ–ã€‚

---

## âœ… å¿«é€Ÿçµè«–

### **æ­£ç¢ºçš„åˆ†æ**
- âœ… **åˆå§‹åŒ–é †åºé¢¨éšª** - è·¨ç¿»è­¯å–®å…ƒçš„staticç‰©ä»¶åˆå§‹åŒ–é †åºæœªå®šç¾©
- âœ… **å‡½å¼å…§staticçš„å®ˆé–€é–‹éŠ·** - C++ magic static åœ¨é«˜é »èª¿ç”¨ä¸­æˆç‚ºç†±é»
- âœ… **é«˜é »LOG/millis()æ”¾å¤§é¢¨éšª** - éŒ¯èª¤è·¯å¾‘çš„éåº¦è¨ºæ–·è¼¸å‡º
- âœ… **MCU RAMé™åˆ¶** - éœ€ç¯€åˆ¶ç‹€æ…‹å¸¸é§è¨˜æ†¶é«”ä½¿ç”¨

### **éœ€è¦ä¿®æ­£çš„èªçŸ¥**
- âŒ **ã€Œstaticé€ æˆè¨˜æ†¶é«”ç¢ç‰‡åŒ–ã€** â†’ ç¢ç‰‡åŒ–æ˜¯heap/new/mallocçš„å•é¡Œï¼›staticåªä½”ç”¨å›ºå®šå€æ®µ
- âŒ **ã€Œchronoæœƒè¨˜æ†¶é«”æ´©æ¼ã€** â†’ `time_point`æ˜¯è¼•é‡PODï¼›å•é¡Œåœ¨å‡½å¼å…§staticå®ˆé–€æª¢æŸ¥
- âŒ **ã€Œå»ºæ§‹å­å¤±æ•—=æœªå®šç¾©è¡Œç‚ºã€** â†’ MCUç·¨è­¯éˆå¤šæ•¸ç¦ç”¨ä¾‹å¤–ï¼›çœŸæ­£é¢¨éšªæ˜¯è¤‡é›œå»ºæ§‹+åˆå§‹åŒ–æ™‚æ©Ÿ

---

## ğŸ” æ­»æ©Ÿæ ¹å› åˆ†æ

### **commit 53442ca çš„å•é¡Œä»£ç¢¼**

```cpp
// src/adapter/imu_adapter.h - æ¯å€‹å‡½æ•¸éƒ½æœ‰å¤šå€‹staticï¼
inline mu::Vector3f getAccelerationVector(const IMUData& imu_data) {
    static mu::Vector3f last_valid_accel(0.0f, 0.0f, -9.81f);  // ğŸš¨ å‡½å¼å…§static
    static bool first_call = true;                              // ğŸš¨ å‡½å¼å…§static
    static uint32_t last_warn_time = 0;                         // ğŸš¨ å‡½å¼å…§static + é«˜é »millis()
    
    uint32_t now = millis();  // ğŸš¨ æ¯æ¬¡ç„¡æ•ˆæ•¸æ“šéƒ½èª¿ç”¨è‡ªè£½millis()
    if (now - last_warn_time >= 1000) {
        LOGW("IMU_ADAPTER", "âš ï¸ åŠ é€Ÿåº¦æ•¸æ“šç„¡æ•ˆï¼Œä½¿ç”¨ä¸Šæ¬¡æœ‰æ•ˆå€¼é˜²æ­¢Valley");  // ğŸš¨ é«˜é »LOG
    }
}

// è‡ªè£½millis()å¯¦ç¾
inline uint32_t millis() {
    static auto start = std::chrono::steady_clock::now();  // ğŸš¨ åˆä¸€å€‹å‡½å¼å…§staticï¼
    auto now = std::chrono::steady_clock::now();
    return std::chrono::duration_cast<std::chrono::milliseconds>(now - start).count();
}
```

### **ğŸ¯ çœŸæ­£çš„æ­»æ©Ÿæ©Ÿåˆ¶**

| é¢¨éšªå› å­ | å•é¡Œæè¿° | å½±éŸ¿ |
|---------|---------|------|
| **C++ Magic Static å®ˆé–€** | æ¯å€‹å‡½å¼å…§staticéƒ½æœ‰åŸ·è¡Œç·’å®‰å…¨æª¢æŸ¥ | é«˜é »èª¿ç”¨æ™‚CPUé–‹éŠ· |
| **ç†±è·¯å¾‘millis()èª¿ç”¨** | æ¯æ¬¡IMUæ•¸æ“šç„¡æ•ˆéƒ½è§¸ç™¼æ™‚é–“è¨ˆç®— | chronoå°è±¡è¨ˆç®—è² æ“” |
| **é«˜é »LOGèª¿ç”¨** | éŒ¯èª¤è·¯å¾‘æ¯ç§’è§¸ç™¼LOGW | printfæ ¼å¼åŒ–+ä¸²å£é˜»å¡ |
| **åˆå§‹åŒ–æ™‚æ©Ÿå•é¡Œ** | staticåˆå§‹åŒ–å¯èƒ½åœ¨ç³»çµ±æœªæº–å‚™å¥½æ™‚ç™¼ç”Ÿ | æœªå®šç¾©è¡Œç‚ºé¢¨éšª |

---

## ğŸ› ï¸ å®‰å…¨è½åœ°æ–¹æ¡ˆ

### **1. æ™‚åŸºé›†ä¸­ç®¡ç†ï¼ˆé¿å…å‡½å¼å…§staticå®ˆé–€ï¼‰**

```cpp
// time_base.cpp - æª”æ¡ˆå±¤staticï¼Œä¸€æ¬¡æ€§åˆå§‹åŒ–
namespace hal {
    static const auto kT0 = std::chrono::steady_clock::now(); // å•Ÿå‹•æœŸå®Œæˆä¸€æ¬¡
    
    uint32_t millis() {
        using namespace std::chrono;
        return static_cast<uint32_t>(
            duration_cast<milliseconds>(steady_clock::now() - kT0).count()
        );
    }
}
```

### **2. IMUç‹€æ…‹çµæ§‹åŒ–ç®¡ç†**

```cpp
// imu_adapter.cpp - å–®ä¸€ç‹€æ…‹çµæ§‹ï¼Œé¿å…å¤šå€‹å‡½å¼å…§static
namespace {
    struct IMUState {
        mu::Vector3f last_acc{0.0f, 0.0f, -9.81f};
        mu::Vector3f last_gyr{0.0f, 0.0f,  0.0f};
        uint32_t     last_warn{0};
        bool         seen_valid{false};
    };
    IMUState st; // å–®ä¸€å®ˆé–€ï¼Œç„¡å‡½å¼å…§static
}

inline bool should_log(uint32_t now, uint32_t& last, uint32_t interval_ms) {
    if (now - last >= interval_ms) { 
        last = now; 
        return true; 
    }
    return false;
}

void IMUAdapter::process(const RawIMU& in, IMUData& out) {
    const uint32_t now = hal::millis();

    if (!isValid(in)) {
        out.accel = st.last_acc;
        out.gyro  = st.last_gyr;
        // é™æµè‡³5ç§’ï¼Œæ¸›å°‘LOGå£“åŠ›
        if (should_log(now, st.last_warn, 5000)) { 
            LOGW("IMU_ADAPTER","Accel invalid; hold"); 
        }
        return;
    }
    st.seen_valid = true;
    st.last_acc   = out.accel = in.accel;
    st.last_gyr   = out.gyro  = in.gyro;
}
```

### **3. åˆå§‹åŒ–é †åºæ²»ç†**

```cpp
// ç³»çµ±å•Ÿå‹•åºåˆ— - é¿å…è·¨æª”æ¡ˆä¾è³´
void system_startup() {
    init_logging();      // 1. å»ºç«‹æ—¥èªŒç³»çµ±
    init_timebase();     // 2. å»ºç«‹æ™‚é–“åŸºæº–
    init_hal();          // 3. åˆå§‹åŒ–ç¡¬é«”æŠ½è±¡å±¤
    init_protocols();    // 4. åˆå§‹åŒ–å”è­°å±¤
    run();               // 5. é–‹å§‹ä¸»å¾ªç’°
}

// é¿å…é€™ç¨®è·¨æª”æ¡ˆstaticä¾è³´
// âŒ static CommandHandler handler(&controller);
// âœ… æ”¹ç‚ºï¼š
//    controller.init(); 
//    handler.bind(controller);
```

---

## ğŸ“Š é¢¨éšªè©•ä¼°è¡¨

| é …ç›® | åŸèªçŸ¥ | ä¿®æ­£å¾ŒèªçŸ¥ | å»ºè­°åšæ³• |
|-----|-------|-----------|---------|
| **å‡½å¼å…§static** | å®¹æ˜“å°è‡´æ­»æ©Ÿ | **éƒ¨åˆ†æ­£ç¢º**ï¼šæœ‰C++ magic staticå®ˆé–€æª¢æŸ¥ç†±é»é¢¨éšª | æŠŠç‹€æ…‹æ¬åˆ°æª”æ¡ˆå±¤Stateçµæ§‹æˆ–ç‰©ä»¶æˆå“¡ |
| **å…¨åŸŸ/æª”æ¡ˆå±¤static** | åˆå§‹åŒ–é †åºæœªå®šç¾© | **æ­£ç¢ºä½†éœ€è£œå……**ï¼šè·¨ç¿»è­¯å–®å…ƒé †åºæœªå®šç¾©ï¼›åŒæª”æ¡ˆä¾å®£å‘Šé †åº | é¿å…è·¨æª”æ¡ˆä¾è³´ï¼›ç”¨å•Ÿå‹•æµç¨‹init() |
| **è¨˜æ†¶é«”ç¢ç‰‡åŒ–** | staticæœƒé€ æˆç¢ç‰‡ | **éŒ¯èª¤**ï¼šç¢ç‰‡ä¾†è‡ªheapï¼›staticæ˜¯å›ºå®šå€ï¼Œä¸ç¢ç‰‡åŒ– | æ³¨æ„ç¸½é‡(.bss/.data)èˆ‡å †ç–Šç©ºé–“ |
| **chrono/millis()** | å¯èƒ½æ´©æ¼/å¾ˆé‡ | **ä¸æ­£ç¢º**ï¼štime_pointç„¡æ´©æ¼ï¼›é‡é»æ˜¯å‡½å¼å…§staticèµ·é» | kT0æ”¾æª”æ¡ˆå±¤constï¼Œmillis()åƒ…åšå·®å€¼è½‰å‹ |
| **LOGéè¼‰** | æ¯ç§’WARNå±éšª | **æ­£ç¢º**ï¼šprintf/æ ¼å¼åŒ–/emoji/ä¸²å£é˜»å¡é€ æˆå£“åŠ› | é™æµ(â‰¥5s)ã€ç°¡è¨Šæ¯ã€ç¦emojiã€é¿å…æµ®é»æ ¼å¼åŒ– |

---

## ğŸ§ª é©—è­‰æ–¹æ³•

### **å£“åŠ›æ¸¬è©¦**
1. **1kHzå£“æ¸¬** `IMUAdapter::process()` 30ç§’ â†’ ç„¡å´©æ½°ã€WARNæ¯5sä¸€æ¬¡
2. **æ™‚é–“å›ç¹æ¸¬è©¦** è¨­å®š `st.last_warn = UINT32_MAX-100` â†’ ç¢ºèªé™æµä»æ­£ç¢º
3. **LOGç°¡åŒ–æ¸¬è©¦** é—œæ‰emoji/æµ®é»æ ¼å¼åŒ– â†’ ä¸²å£é˜»å¡æ˜é¡¯ä¸‹é™

### **è¨˜æ†¶é«”ç›£æ§**
```cpp
// ç·¨è­¯æ™‚æª¢æŸ¥staticè¨˜æ†¶é«”ä½¿ç”¨
static_assert(sizeof(IMUState) < 64, "IMUState too large");

// é‹è¡Œæ™‚ç›£æ§å¯ç”¨è¨˜æ†¶é«”
#ifdef ESP32
void check_memory() {
    size_t free_heap = ESP.getFreeHeap();
    LOGI("Free heap: %zu bytes", free_heap);
}
#endif
```

---

## ğŸ§­ Staticä½¿ç”¨æ±ºç­–æµç¨‹

```mermaid
flowchart TD
  A[éœ€è¦è·¨å‘¼å«ä¿ç•™ç‹€æ…‹?] -->|å¦| B[ä¸€èˆ¬å€åŸŸè®Šæ•¸]
  A -->|æ˜¯| C[ç†±è·¯å¾‘?]
  C -->|æ˜¯| D[æ”¹ç‚ºæª”æ¡ˆå±¤State/æˆå“¡è®Šæ•¸]
  C -->|å¦| E[å‡½å¼å…§staticå¯æ¥å—]
  D --> F[ç¶“å•Ÿå‹•åºåˆ—åˆå§‹åŒ–]
  E --> G[è©•ä¼°å®ˆé–€æª¢æŸ¥/åŸ·è¡Œç·’/ISRé¢¨éšª]
```

---

## ğŸ¯ é—œéµä¿®å¾©å»ºè­°

### **ç«‹å³è¡Œå‹•**
1. **ç§»é™¤å‡½å¼å…§static** - æ•´åˆåˆ°æª”æ¡ˆå±¤ç‹€æ…‹çµæ§‹
2. **é™åˆ¶LOGé »ç‡** - éŒ¯èª¤è·¯å¾‘é™æµè‡³5ç§’ä»¥ä¸Š
3. **ç°¡åŒ–millis()** - æ™‚é–“åŸºæº–ç§»è‡³æª”æ¡ˆå±¤static const
4. **æ¸…ç†æ ¼å¼åŒ–** - ç§»é™¤emojiã€æµ®é»æ ¼å¼åŒ–ã€éé•·å­—ä¸²

### **æ¶æ§‹æ”¹å–„**
1. **ç³»çµ±å•Ÿå‹•åºåˆ—** - æ˜ç¢ºçš„åˆå§‹åŒ–é †åº
2. **ç‹€æ…‹æ”¶æ–‚** - é¿å…æ•£äº‚çš„éœæ…‹è®Šæ•¸
3. **éŒ¯èª¤è™•ç†** - å„ªé›…é™ç´šè€Œéé »ç¹è­¦å‘Š

---

## ğŸ“ çµè«–

aa4ca7c â†’ b3a0829 çš„æ­»æ©Ÿå•é¡Œä¸»è¦ä¾†è‡ªæ–¼ **53442ca commit ä¸­IMU adapterçš„å‡½å¼å…§staticæ¿«ç”¨**ï¼Œå°è‡´ï¼š

1. **C++ magic staticå®ˆé–€æª¢æŸ¥** åœ¨é«˜é »IMUè™•ç†ä¸­æˆç‚ºæ€§èƒ½ç“¶é ¸
2. **è‡ªè£½millis()çš„chronoè¨ˆç®—** åœ¨ç†±è·¯å¾‘è¢«é »ç¹èª¿ç”¨
3. **é«˜é »LOGè¼¸å‡º** é€ æˆä¸²å£é˜»å¡å’Œæ ¼å¼åŒ–é–‹éŠ·
4. **åˆå§‹åŒ–æ™‚æ©Ÿå•é¡Œ** å¯èƒ½åœ¨ç³»çµ±æœªæº–å‚™å¥½æ™‚è§¸ç™¼

**è§£æ±ºæ–¹æ¡ˆæ˜¯ç‹€æ…‹æ”¶æ–‚ã€æ™‚åŸºå‰ç§»ã€éŒ¯èª¤è·¯å¾‘é™æµï¼Œè€Œéé¿å…æ‰€æœ‰staticä½¿ç”¨**ã€‚æ­£ç¢ºä½¿ç”¨çš„æª”æ¡ˆå±¤staticæ˜¯å®‰å…¨ä¸”å¿…è¦çš„ã€‚