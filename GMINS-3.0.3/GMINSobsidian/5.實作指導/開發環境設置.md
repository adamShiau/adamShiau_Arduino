# 開發環境設置

> **功能**: GMINS v2.0 開發環境配置和工具鏈設置指南  
> **版本**: v2.0  
> **最後更新**: 2025-08-08  
> **支援平台**: Windows, macOS, Linux

## 🎯 開發環境概覽

### 核心開發工具
1. **PlatformIO**: 主要開發平台和建構系統
2. **Visual Studio Code**: 推薦的整合開發環境
3. **Git**: 版本控制系統
4. **Unity**: 單元測試框架
5. **Arduino CLI**: Arduino 相關工具鏈

### 系統需求
- **作業系統**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **記憶體**: 最少 4GB RAM (推薦 8GB+)
- **儲存空間**: 至少 2GB 可用空間
- **網路**: 穩定的網路連接 (下載相依套件)

## 🔧 開發工具安裝

### 1. Visual Studio Code 安裝
```bash
# Windows (使用 Chocolatey)
choco install vscode

# macOS (使用 Homebrew)
brew install --cask visual-studio-code

# Ubuntu
sudo snap install --classic code
```

### 2. PlatformIO 安裝
```bash
# 方法一：通過 VS Code 擴展安裝
# 1. 打開 VS Code
# 2. 進入擴展面板 (Ctrl+Shift+X)
# 3. 搜索 "PlatformIO IDE"
# 4. 安裝 PlatformIO IDE 擴展

# 方法二：通過 pip 安裝
pip install platformio

# 驗證安裝
pio --version
```

### 3. Git 安裝和配置
```bash
# Windows
winget install Git.Git

# macOS
brew install git

# Ubuntu
sudo apt-get install git

# Git 全局配置
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
git config --global init.defaultBranch main
```

## 📁 專案結構設置

### 創建新的 GMINS 專案
```bash
# 創建專案目錄
mkdir GMINS_v2.0
cd GMINS_v2.0

# 初始化 PlatformIO 專案
pio project init --board zeroUSB --ide vscode

# 創建完整目錄結構
mkdir -p src/{core,communication,data,utils,hardware,external}
mkdir -p tests/{unit_tests,integration_tests,system_tests}
mkdir -p docs/{api,examples,diagrams}
mkdir -p tools/{config_tools,test_tools}
mkdir -p .vscode
```

### PlatformIO 專案配置
```ini
; platformio.ini
[platformio]
default_envs = arduino_zero
src_dir = src
test_dir = tests
data_dir = data
lib_dir = lib

; 開發環境配置
[env:arduino_zero]
platform = atmelsam
board = zeroUSB  
framework = arduino
monitor_speed = 115200
lib_ldf_mode = deep+

; 編譯器設置
build_flags = 
    -DGMINS_VERSION=2.0
    -std=c++14
    -Wall
    -Wextra
    -O2

; 除錯設置
build_type = debug
debug_tool = atmel-ice
debug_init_break = tbreak setup

; 函式庫相依性
lib_deps = 
    SPI
    Wire
    ArduinoJson@^6.19.0
    Unity

; 測試環境
[env:native_test]
platform = native
framework = 
build_flags = 
    -DUNIT_TEST
    -std=c++14
test_framework = unity
test_filter = unit_tests/*
test_build_src = true

; 整合測試環境
[env:integration_test]  
platform = atmelsam
board = zeroUSB
framework = arduino
test_framework = unity
test_filter = integration_tests/*
upload_protocol = atmel-ice

; 性能測試環境
[env:performance_test]
platform = atmelsam
board = zeroUSB
framework = arduino
build_flags = 
    -DPERFORMANCE_TEST
    -O3
test_filter = performance_tests/*
```

## ⚙️ VS Code 配置

### 工作區設置
```json
// .vscode/settings.json
{
    "C_Cpp.intelliSenseEngine": "Tag Parser",
    "C_Cpp.default.cppStandard": "c++14",
    "C_Cpp.default.cStandard": "c11",
    "C_Cpp.default.compilerPath": "${workspaceFolder}/.pio/build/arduino_zero/src",
    
    "files.associations": {
        "*.h": "cpp",
        "*.cpp": "cpp",
        "*.ino": "cpp"
    },
    
    "files.exclude": {
        "**/.pio": true,
        "**/build": true,
        "**/*.o": true,
        "**/*.bin": true,
        "**/*.hex": true
    },
    
    "editor.tabSize": 4,
    "editor.insertSpaces": true,
    "editor.rulers": [100],
    
    "terminal.integrated.shell.windows": "powershell.exe",
    
    "platformio-ide.useBuiltinPIOCore": true,
    "platformio-ide.activateOnlyOnPlatformIOProject": false
}
```

### 推薦擴展
```json
// .vscode/extensions.json
{
    "recommendations": [
        "platformio.platformio-ide",
        "ms-vscode.cpptools",
        "ms-vscode.cmake-tools",
        "twxs.cmake",
        "ms-python.python",
        "streetsidesoftware.code-spell-checker",
        "gruntfuggly.todo-tree",
        "aaron-bond.better-comments",
        "ms-vscode.hexeditor",
        "ms-vscode-remote.remote-ssh"
    ]
}
```

### 建構和除錯配置
```json
// .vscode/tasks.json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "PlatformIO: Build",
            "type": "shell",
            "command": "pio run",
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "presentation": {
                "panel": "new"
            },
            "problemMatcher": ["$gcc"]
        },
        {
            "label": "PlatformIO: Upload",
            "type": "shell",
            "command": "pio run -t upload",
            "group": "build",
            "presentation": {
                "panel": "new"
            }
        },
        {
            "label": "PlatformIO: Clean",
            "type": "shell",
            "command": "pio run -t clean",
            "group": "build"
        },
        {
            "label": "PlatformIO: Test",
            "type": "shell",
            "command": "pio test",
            "group": "test",
            "presentation": {
                "panel": "new"
            }
        },
        {
            "label": "Run Unit Tests",
            "type": "shell",
            "command": "pio test -e native_test",
            "group": "test"
        },
        {
            "label": "Generate Documentation",
            "type": "shell",
            "command": "doxygen Doxyfile",
            "group": "build"
        }
    ]
}
```

### 除錯配置
```json
// .vscode/launch.json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "PlatformIO Debugger",
            "type": "platformio-debug",
            "request": "launch",
            "preLaunchTask": "PlatformIO: Build",
            "internalConsoleOptions": "openOnSessionStart"
        },
        {
            "name": "Unity Test Debugger",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/.pio/build/native_test/program",
            "args": [],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ],
            "preLaunchTask": "PlatformIO: Build"
        }
    ]
}
```

## 🔨 建構系統配置

### CMake 整合 (選用)
```cmake
# CMakeLists.txt
cmake_minimum_required(VERSION 3.16)
project(GMINS_v2.0)

set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 包含目錄
include_directories(src)
include_directories(lib)

# 編譯選項
add_compile_definitions(
    GMINS_VERSION=2.0
    ARDUINO=100
)

# 源文件收集
file(GLOB_RECURSE CORE_SOURCES "src/core/*.cpp")
file(GLOB_RECURSE COMM_SOURCES "src/communication/*.cpp")
file(GLOB_RECURSE DATA_SOURCES "src/data/*.cpp")
file(GLOB_RECURSE UTILS_SOURCES "src/utils/*.cpp")
file(GLOB_RECURSE HW_SOURCES "src/hardware/*.cpp")

# 創建核心函式庫
add_library(gmins_core 
    ${CORE_SOURCES}
    ${COMM_SOURCES}
    ${DATA_SOURCES}
    ${UTILS_SOURCES}
    ${HW_SOURCES}
)

# 測試配置
enable_testing()

file(GLOB_RECURSE TEST_SOURCES "tests/unit_tests/*.cpp")
add_executable(unit_tests ${TEST_SOURCES})
target_link_libraries(unit_tests gmins_core)

add_test(NAME unit_tests COMMAND unit_tests)

# 文件生成
find_package(Doxygen)
if(DOXYGEN_FOUND)
    configure_file(${CMAKE_CURRENT_SOURCE_DIR}/Doxyfile.in 
                   ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile @ONLY)
    add_custom_target(docs
        ${DOXYGEN_EXECUTABLE} ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile
        WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
        COMMENT "Generating API documentation with Doxygen" VERBATIM
    )
endif()
```

### 自動化建構腳本
```bash
#!/bin/bash
# scripts/build.sh

set -e  # 遇到錯誤時立即退出

# 顏色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Starting GMINS v2.0 build process...${NC}"

# 清理之前的建構
echo -e "${YELLOW}Cleaning previous build...${NC}"
pio run -t clean

# 檢查代碼風格
echo -e "${YELLOW}Checking code style...${NC}"
if command -v clang-format &> /dev/null; then
    find src -name "*.cpp" -o -name "*.h" | xargs clang-format -i
    echo -e "${GREEN}Code formatting completed.${NC}"
else
    echo -e "${YELLOW}clang-format not found, skipping code formatting.${NC}"
fi

# 建構專案
echo -e "${YELLOW}Building project...${NC}"
pio run -e arduino_zero

# 運行單元測試
echo -e "${YELLOW}Running unit tests...${NC}"
pio test -e native_test

# 運行整合測試 (如果硬體可用)
if [ "$1" == "--with-hardware" ]; then
    echo -e "${YELLOW}Running integration tests...${NC}"
    pio test -e integration_test
fi

# 生成文件
echo -e "${YELLOW}Generating documentation...${NC}"
if command -v doxygen &> /dev/null; then
    doxygen Doxyfile
    echo -e "${GREEN}Documentation generated in docs/html/${NC}"
else
    echo -e "${YELLOW}Doxygen not found, skipping documentation generation.${NC}"
fi

echo -e "${GREEN}Build process completed successfully!${NC}"
```

## 📊 代碼品質工具

### 代碼格式化設置
```yaml
# .clang-format
BasedOnStyle: Google
IndentWidth: 4
UseTab: Never
ColumnLimit: 100
AllowShortFunctionsOnASingleLine: InlineOnly
AllowShortIfStatementsOnASingleLine: false
AllowShortLoopsOnASingleLine: false
BreakBeforeBraces: Attach
IndentCaseLabels: false
SpaceAfterCStyleCast: true
SpaceBeforeParens: ControlStatements
```

### 靜態分析配置
```yaml
# .cppcheck
--enable=all
--std=c++14
--platform=avr8
--suppress=missingIncludeSystem
--suppress=unusedFunction
--suppress=unmatchedSuppression
--inline-suppr
--xml
--xml-version=2
```

### Pre-commit 鉤子
```bash
#!/bin/sh
# .git/hooks/pre-commit

# 檢查代碼格式
echo "Checking code format..."
if command -v clang-format &> /dev/null; then
    CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h)$')
    if [ -n "$CHANGED_FILES" ]; then
        for file in $CHANGED_FILES; do
            clang-format -i "$file"
            git add "$file"
        done
    fi
fi

# 運行快速測試
echo "Running unit tests..."
pio test -e native_test --silent

if [ $? -ne 0 ]; then
    echo "Tests failed. Commit aborted."
    exit 1
fi

echo "Pre-commit checks passed."
exit 0
```

## 🚀 開發工作流程

### 日常開發流程
```bash
# 1. 更新代碼庫
git pull origin main

# 2. 創建功能分支
git checkout -b feature/new-fusion-algorithm

# 3. 開發和測試
pio run                    # 建構
pio test -e native_test    # 單元測試
pio run -t upload          # 上傳到硬體

# 4. 提交更改
git add .
git commit -m "Add new fusion algorithm implementation"

# 5. 推送分支
git push origin feature/new-fusion-algorithm

# 6. 創建 Pull Request (在 GitHub/GitLab)
```

### 版本發布流程
```bash
# scripts/release.sh
#!/bin/bash

VERSION=$1
if [ -z "$VERSION" ]; then
    echo "Usage: $0 <version>"
    exit 1
fi

echo "Preparing release $VERSION..."

# 更新版本號
sed -i "s/GMINS_VERSION=.*/GMINS_VERSION=$VERSION/" platformio.ini

# 運行完整測試套件
./scripts/build.sh --with-hardware

# 創建版本標籤
git add .
git commit -m "Bump version to $VERSION"
git tag -a "v$VERSION" -m "Release version $VERSION"

# 推送到遠程
git push origin main
git push origin "v$VERSION"

echo "Release $VERSION created successfully!"
```

## 🔗 相關文件連結

### 開發指導
- [[5.實作指導/編碼規範]] - 代碼風格和開發標準
- [[5.實作指導/測試策略]] - 測試方法和品質保證

### 架構文件
- [[src目錄結構設計]] - 源代碼組織結構
- [[3.軟體架構重新設計/新軟體架構設計]] - 整體軟體架構

### 專案文件
- [[1.系統概覽/GMINS專案架構總覽]] - 專案整體架構
- [[2.硬體架構/硬體架構整合文件]] - 硬體配置說明

---

**最後更新**: 2025-08-08  
**適用版本**: GMINS v2.0  
**維護者**: GMINS 開發團隊  
**支援平台**: PlatformIO + VS Code + Arduino 生態系統